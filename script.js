// ===== CONFIGURATION API =====
const API_KEY = 'bb493abc3be431fe458884ed5a10aa17'; // Cl√© API OpenWeather
const API_BASE_URL = 'https://api.openweathermap.org/data/2.5';
const ICON_BASE_URL = 'https://openweathermap.org/img/wn';

// ===== VARIABLES GLOBALES =====
let currentCity = '';
let lastSearchQuery = '';

// ===== √âL√âMENTS DOM =====
const cityInput = document.getElementById('cityInput');
const searchBtn = document.getElementById('searchBtn');
const retryBtn = document.getElementById('retryBtn');

// √âtats d'affichage
const initialState = document.getElementById('initialState');
const loadingState = document.getElementById('loadingState');
const errorState = document.getElementById('errorState');
const weatherDisplay = document.getElementById('weatherDisplay');

// √âl√©ments d'erreur
const errorTitle = document.getElementById('errorTitle');
const errorMessage = document.getElementById('errorMessage');

// √âl√©ments d'affichage m√©t√©o
const cityName = document.getElementById('cityName');
const country = document.getElementById('country');
const weatherIcon = document.getElementById('weatherIcon');
const currentTemp = document.getElementById('currentTemp');
const weatherDesc = document.getElementById('weatherDesc');
const feelsLike = document.getElementById('feelsLike');
const windSpeed = document.getElementById('windSpeed');
const humidity = document.getElementById('humidity');
const visibility = document.getElementById('visibility');
const pressure = document.getElementById('pressure');
const lastUpdate = document.getElementById('lastUpdate');

// Boutons ville exemple
const cityExamples = document.querySelectorAll('.city-example');

// ===== FONCTIONS UTILITAIRES =====

/**
 * Affiche un √©tat sp√©cifique de l'interface
 * @param {string} state - 'initial', 'loading', 'error', 'weather'
 */
function showState(state) {
    // Masquer tous les √©tats
    initialState.classList.add('hidden');
    loadingState.classList.add('hidden');
    errorState.classList.add('hidden');
    weatherDisplay.classList.add('hidden');
    
    // Afficher l'√©tat demand√©
    switch (state) {
        case 'initial':
            initialState.classList.remove('hidden');
            break;
        case 'loading':
            loadingState.classList.remove('hidden');
            break;
        case 'error':
            errorState.classList.remove('hidden');
            break;
        case 'weather':
            weatherDisplay.classList.remove('hidden');
            break;
    }
}

/**
 * Valide la cl√© API
 * @returns {boolean} - True si la cl√© semble valide
 */
function isValidApiKey() {
    return API_KEY && API_KEY !== 'YOUR_API_KEY_HERE' && API_KEY.length > 10;
}

/**
 * Convertit les m/s en km/h
 * @param {number} ms - Vitesse en m/s
 * @returns {number} - Vitesse en km/h
 */
function msToKmh(ms) {
    return Math.round(ms * 3.6);
}

/**
 * Convertit les m√®tres en kilom√®tres
 * @param {number} meters - Distance en m√®tres
 * @returns {number} - Distance en km
 */
function metersToKm(meters) {
    return Math.round(meters / 1000);
}

/**
 * Capitalise la premi√®re lettre de chaque mot
 * @param {string} str - Cha√Æne √† capitaliser
 * @returns {string} - Cha√Æne capitalis√©e
 */
function capitalizeWords(str) {
    return str.replace(/\b\w/g, letter => letter.toUpperCase());
}

/**
 * Formate la date de mise √† jour
 * @returns {string} - Date format√©e
 */
function getCurrentTimeString() {
    return new Date().toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// ===== FONCTIONS API =====

/**
 * Effectue une requ√™te √† l'API OpenWeather
 * @param {string} city - Nom de la ville
 * @returns {Promise} - Promesse avec les donn√©es m√©t√©o
 */
async function fetchWeatherData(city) {
    if (!isValidApiKey()) {
        throw new Error('Cl√© API manquante ou invalide');
    }
    
    const url = `${API_BASE_URL}/weather?q=${encodeURIComponent(city)}&appid=${API_KEY}&units=metric&lang=fr`;
    
    console.log('üåê Requ√™te API m√©t√©o pour:', city);
    
    const response = await fetch(url);
    
    if (!response.ok) {
        switch (response.status) {
            case 404:
                throw new Error('Ville non trouv√©e. V√©rifiez l\'orthographe.');
            case 401:
                throw new Error('Cl√© API invalide ou expir√©e.');
            case 429:
                throw new Error('Trop de requ√™tes. Veuillez patienter un moment.');
            case 500:
                throw new Error('Erreur serveur. R√©essayez plus tard.');
            default:
                throw new Error(`Erreur API (${response.status})`);
        }
    }
    
    const data = await response.json();
    console.log('‚úÖ Donn√©es m√©t√©o re√ßues:', data);
    return data;
}

/**
 * Met √† jour l'affichage avec les donn√©es m√©t√©o
 * @param {Object} data - Donn√©es m√©t√©o de l'API
 */
function updateWeatherDisplay(data) {
    try {
        // Informations de base
        cityName.textContent = data.name;
        country.textContent = data.sys.country;
        
        // Temp√©rature
        currentTemp.textContent = Math.round(data.main.temp);
        feelsLike.querySelector('span').textContent = Math.round(data.main.feels_like);
        
        // Description m√©t√©o
        weatherDesc.textContent = capitalizeWords(data.weather[0].description);
        
        // Ic√¥ne m√©t√©o
        const iconCode = data.weather[0].icon;
        weatherIcon.src = `${ICON_BASE_URL}/${iconCode}@2x.png`;
        weatherIcon.alt = data.weather[0].description;
        
        // D√©tails
        windSpeed.textContent = `${msToKmh(data.wind.speed)} km/h`;
        humidity.textContent = `${data.main.humidity}%`;
        visibility.textContent = data.visibility ? `${metersToKm(data.visibility)} km` : 'N/A';
        pressure.textContent = `${data.main.pressure} hPa`;
        
        // Heure de mise √† jour
        lastUpdate.querySelector('span').textContent = getCurrentTimeString();
        
        // Afficher l'√©tat m√©t√©o
        showState('weather');
        
        console.log('‚úÖ Affichage m√©t√©o mis √† jour');
        
    } catch (error) {
        console.error('‚ùå Erreur lors de la mise √† jour de l\'affichage:', error);
        showError('Erreur d\'affichage', 'Impossible d\'afficher les donn√©es m√©t√©o.');
    }
}

/**
 * Affiche une erreur √† l'utilisateur
 * @param {string} title - Titre de l'erreur
 * @param {string} message - Message d'erreur
 */
function showError(title, message) {
    errorTitle.textContent = title;
    errorMessage.textContent = message;
    showState('error');
}

/**
 * Recherche la m√©t√©o d'une ville
 * @param {string} city - Nom de la ville √† rechercher
 */
async function searchWeather(city) {
    if (!city.trim()) {
        showError('Champ vide', 'Veuillez entrer le nom d\'une ville.');
        return;
    }
    
    // V√©rifier la cl√© API avant de faire la requ√™te
    if (!isValidApiKey()) {
        showError('Configuration manquante', 'La cl√© API n\'est pas configur√©e. Consultez la documentation.');
        return;
    }
    
    currentCity = city.trim();
    lastSearchQuery = currentCity;
    
    // Afficher l'√©tat de chargement
    showState('loading');
    
    try {
        const data = await fetchWeatherData(currentCity);
        updateWeatherDisplay(data);
        
        // Vider le champ de recherche apr√®s succ√®s
        cityInput.value = '';
        
    } catch (error) {
        console.error('‚ùå Erreur lors de la recherche m√©t√©o:', error);
        
        // Gestion des erreurs sp√©cifiques
        if (error.message.includes('Cl√© API')) {
            showError('Probl√®me de configuration', error.message);
        } else if (error.message.includes('Ville non trouv√©e')) {
            showError('Ville introuvable', `"${currentCity}" n'a pas √©t√© trouv√©e. V√©rifiez l'orthographe.`);
        } else if (error.name === 'TypeError' || error.message.includes('Failed to fetch')) {
            showError('Probl√®me de connexion', 'V√©rifiez votre connexion internet et r√©essayez.');
        } else {
            showError('Erreur', error.message);
        }
    }
}

// ===== GESTIONNAIRES D'√âV√âNEMENTS =====

/**
 * Initialise tous les gestionnaires d'√©v√©nements
 */
function initEventListeners() {
    // Recherche par clic sur le bouton
    searchBtn.addEventListener('click', () => {
        searchWeather(cityInput.value);
    });
    
    // Recherche par pression sur Entr√©e
    cityInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            searchWeather(cityInput.value);
        }
    });
    
    // Bouton de retry
    retryBtn.addEventListener('click', () => {
        if (lastSearchQuery) {
            searchWeather(lastSearchQuery);
        } else {
            showState('initial');
        }
    });
    
    // Boutons d'exemple de villes
    cityExamples.forEach(btn => {
        btn.addEventListener('click', () => {
            const city = btn.dataset.city;
            cityInput.value = city;
            searchWeather(city);
        });
    });
    
    // Focus automatique sur l'input
    cityInput.focus();
}

// ===== INITIALISATION =====

/**
 * Initialise l'application
 */
function initApp() {
    console.log('üå§Ô∏è Initialisation de l\'application m√©t√©o...');
    
    // V√©rifier la configuration
    if (!isValidApiKey()) {
        console.warn('‚ö†Ô∏è Cl√© API non configur√©e - fonctionnalit√©s limit√©es');
    }
    
    // Initialiser les √©v√©nements
    initEventListeners();
    
    // Afficher l'√©tat initial
    showState('initial');
    
    console.log('‚úÖ Application m√©t√©o initialis√©e');
}

// ===== D√âMARRAGE DE L'APPLICATION =====

// D√©marrer l'application quand le DOM est charg√©
document.addEventListener('DOMContentLoaded', initApp);

// ===== FONCTIONS DE DEBUG =====

// Rendre certaines fonctions disponibles globalement pour le debug
window.debugWeatherApp = {
    searchWeather: (city) => searchWeather(city),
    showState: (state) => showState(state),
    isValidApiKey: () => isValidApiKey(),
    getCurrentCity: () => currentCity
};
